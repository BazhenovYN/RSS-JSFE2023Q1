(()=>{"use strict";const e="Good luck and be careful!",t={name:"Easy",sizeX:10,sizeY:10,mineCount:10,maxMineCount:99},n={name:"Medium",sizeX:15,sizeY:15,mineCount:40,maxMineCount:224},s={name:"Hard",sizeX:25,sizeY:25,mineCount:99,maxMineCount:624};function i(e,t){return Math.floor(Math.random()*(t-e+1))+e}function l(e){localStorage.setItem("saveSlot",JSON.stringify(e))}function a(){localStorage.removeItem("saveSlot")}function d(){return JSON.parse(localStorage.getItem("totalScore"))}function o(e){return e>999?"999":e<-99?"-99":e<0?`-${`000${Math.abs(e)}`.slice(-2)}`:`000${e}`.slice(-3)}function c(e,t,n,s){const i=document.createDocumentFragment(),l=document.createElement("input");l.type="radio",l.name=e,l.checked=n,l.setAttribute("value",t),l.addEventListener("change",s);const a=document.createElement("label");a.htmlFor=e,a.textContent=t;const d=document.createElement("div");return d.classList.add("radio-button"),d.appendChild(l),d.appendChild(a),i.appendChild(d),i}function m(){const e=document.createDocumentFragment(),t=document.createElement("div");return t.classList.add("warning-restart","hidden"),t.title="Need to create a new game",e.appendChild(t),e}let h=localStorage.getItem("mainTheme")||"light",r=JSON.parse(localStorage.getItem("muteSounds"))||!1,u=JSON.parse(localStorage.getItem("difficultyLevel"))||t,C=u.mineCount;function g(e){const t=document.querySelector(".body");var n;"Dark"===e.target.value?(t.classList.remove("theme-light"),t.classList.add("theme-dark"),h="dark"):(t.classList.remove("theme-dark"),t.classList.add("theme-light"),h="light"),n=h,localStorage.setItem("mainTheme",n)}function p(e){r="Off"===e.target.value,function(e){localStorage.setItem("muteSounds",e)}(r)}const v=new class{constructor(){this.sizeX=0,this.sizeY=0,this.mineCount=0,this.minesRemaining=0,this.timer=0,this.timerId=0,this.moveCount=0,this.gameOn=!1,this.win=!1,this.lose=!1,this.difficultyLevel=null,this.cells=[],this.mines=[],this.elements={cells:null,mineCount:null,minesRemaining:null,timer:null,moveCount:null,message:null,settings:null,customMineCount:null,score:null},this.audioClick=new Audio,this.audioClick.src="./assets/sounds/click.wav",this.audioClick.preload="auto",this.audioWin=new Audio,this.audioWin.src="./assets/sounds/win.wav",this.audioWin.preload="auto",this.audioLose=new Audio,this.audioLose.src="./assets/sounds/lose.wav",this.audioLose.preload="auto"}toJSON(){return{sizeX:this.sizeX,sizeY:this.sizeY,mineCount:this.mineCount,minesRemaining:this.minesRemaining,timer:this.timer,moveCount:this.moveCount,cells:this.cells,mines:this.mines,difficultyLevel:this.difficultyLevel}}init(){const e=JSON.parse(localStorage.getItem("saveSlot"));e?(this.sizeX=e.sizeX,this.sizeY=e.sizeY,this.difficultyLevel=e.difficultyLevel,this.mineCount=e.mineCount,this.minesRemaining=e.minesRemaining,this.timer=e.timer,this.moveCount=e.moveCount,this.cells=e.cells,this.mines=e.mines,this.generateHtml(),this.continueGame()):(this.sizeX=u.sizeX,this.sizeY=u.sizeY,this.mineCount=u.mineCount,this.minesRemaining=u.mineCount,this.difficultyLevel=u,this.generateEmptyMinefield(),this.generateHtml())}generateEmptyMinefield(){this.cells=[];for(let e=0;e<this.sizeX;e+=1){this.cells[e]=[];for(let t=0;t<this.sizeY;t+=1)this.cells[e][t]={i:e,j:t,opened:!1,flagged:!1,mined:!1,neighborMineCount:0}}}generateHtml(){const t=document.createElement("h1");t.textContent="RSS Minesweeper",t.classList.add("title"),this.elements.message=document.createElement("div"),this.elements.message.textContent=e,this.elements.message.classList.add("message");const n=document.createElement("button");n.textContent="New game",n.classList.add("button","menu__new-game"),n.addEventListener("click",(()=>{this.stopGame(),this.createNewGame()}));const s=document.createElement("button");s.textContent="Settings",s.classList.add("button","menu__settings"),s.addEventListener("click",(()=>{this.elements.settings.classList.contains("hidden")?this.showSettings():this.hideSettings()}));const i=document.createElement("button");i.textContent="Score",i.classList.add("button","menu__score"),i.addEventListener("click",(()=>{this.elements.score.classList.contains("hidden")?this.showScore():this.hideScore()}));const l=document.createElement("div");l.classList.add("info__description"),l.textContent="Mines",this.elements.mineCount=document.createElement("div"),this.elements.mineCount.classList.add("info__value"),this.elements.mineCount.textContent=o(this.mineCount);const a=document.createElement("div");a.classList.add("info__container"),a.appendChild(this.elements.mineCount),a.appendChild(l);const d=document.createElement("div");d.classList.add("info__description"),d.textContent="Flags",this.elements.minesRemaining=document.createElement("div"),this.elements.minesRemaining.classList.add("info__value"),this.elements.minesRemaining.textContent=o(this.minesRemaining);const m=document.createElement("div");m.classList.add("info__container"),m.appendChild(this.elements.minesRemaining),m.appendChild(d);const u=document.createElement("div");u.classList.add("info"),u.appendChild(a),u.appendChild(m);const C=document.createElement("div");C.classList.add("info__description"),C.textContent="Time",this.elements.timer=document.createElement("div"),this.elements.timer.classList.add("info__value"),this.elements.timer.textContent=o(this.timer);const v=document.createElement("div");v.classList.add("info__container"),v.appendChild(C),v.appendChild(this.elements.timer);const f=document.createElement("div");f.classList.add("info__description"),f.textContent="Clicks",this.elements.moveCount=document.createElement("div"),this.elements.moveCount.classList.add("info__value"),this.elements.moveCount.textContent=o(this.moveCount);const L=document.createElement("div");L.classList.add("info__container"),L.appendChild(f),L.appendChild(this.elements.moveCount);const E=document.createElement("div");E.classList.add("info"),E.appendChild(v),E.appendChild(L);const y=document.createElement("div");y.classList.add("menu"),y.appendChild(u),y.appendChild(n),y.appendChild(E);const _=document.createElement("div");_.classList.add("menu"),_.appendChild(s),_.appendChild(i),this.elements.cells=document.createElement("div"),this.elements.cells.classList.add("cells"),this.elements.cells.appendChild(this.generateHtmlCells());const S=document.createElement("div");S.classList.add("board"),S.classList.add(`board_${this.difficultyLevel.name.toLowerCase()}`);const b=document.createElement("div");b.classList.add("board__inner"),b.appendChild(y),b.appendChild(this.elements.cells),b.appendChild(_),S.appendChild(b),this.elements.settings=document.createElement("div"),this.elements.settings.appendChild(function(){const e="dark"===h,t=document.createDocumentFragment(),n=document.createElement("div");n.textContent="Theme:";const s=document.createElement("div");return s.classList.add("settings__theme"),s.appendChild(n),s.appendChild(c("theme","Light",!e,g)),s.appendChild(c("theme","Dark",e,g)),t.appendChild(s),t}()),this.elements.settings.appendChild(function(){const e=document.createDocumentFragment(),t=document.createElement("div");t.textContent="Sounds:";const n=document.createElement("div");return n.classList.add("settings__sounds"),n.appendChild(t),n.appendChild(c("sounds","On",!r,p)),n.appendChild(c("sounds","Off",r,p)),e.appendChild(n),e}()),this.elements.settings.appendChild(this.generateLevelSelection()),this.elements.settings.appendChild(this.generateMineCountSelection()),this.elements.settings.classList.add("settings","hidden"),this.elements.customMineCount=this.elements.settings.querySelector('input[name="mine-count"]'),this.elements.score=document.createElement("div"),this.elements.score.classList.add("score","hidden");const x=document.createElement("div");x.classList.add("container"),x.appendChild(t),x.appendChild(this.elements.message),x.appendChild(S),x.appendChild(this.elements.settings),x.appendChild(this.elements.score);const M=document.querySelector("body");M.classList.add("body"),"dark"===h?M.classList.add("body","theme-dark"):M.classList.add("body","theme-light"),document.body.appendChild(x)}generateHtmlCells(){const e=document.createDocumentFragment();for(let t=0;t<this.sizeX;t+=1){const n=document.createElement("div");n.classList.add("line");for(let e=0;e<this.sizeY;e+=1){const s=document.createElement("div");s.id=`cell-${t}-${e}`,s.classList.add("cell"),s.classList.add(...this.getCellClasses(t,e)),s.setAttribute("i",t),s.setAttribute("j",e);const i=this.getCellValue(t,e);i>0&&(s.innerText=i,s.setAttribute("value",i)),s.addEventListener("click",(e=>{this.handleLeftClick(e)})),s.addEventListener("contextmenu",(e=>{this.handleRightClick(e)})),n.appendChild(s)}e.appendChild(n)}return e}resetHtml(){for(;this.elements.cells.firstChild;)this.elements.cells.removeChild(this.elements.cells.firstChild);this.elements.cells.appendChild(this.generateHtmlCells()),this.elements.message.classList.remove("message_win","message_lose"),this.elements.message.textContent=e,this.elements.mineCount.textContent=o(this.mineCount),this.elements.minesRemaining.textContent=o(this.minesRemaining),this.elements.timer.textContent=o(this.timer),this.elements.moveCount.textContent=o(this.moveCount);const t=document.querySelector(".board");t.classList.remove("board_easy","board_medium","board_hard"),t.classList.add(`board_${u.name.toLowerCase()}`)}handleDifficultyLevelChange(e){u="Hard"===e.target.value?s:"Medium"===e.target.value?n:t,function(e){localStorage.setItem("difficultyLevel",JSON.stringify(e))}(u),C=u.mineCount,this.elements.customMineCount.value=C,document.querySelector(".settings__difficulty .warning-restart").classList.remove("hidden")}generateLevelSelection(){let e,t,n;"Hard"===u.name?n=!0:"Medium"===u.name?t=!0:e=!0;const s=document.createDocumentFragment(),i=document.createElement("div");i.textContent="Difficulty:";const l=document.createElement("div");return l.classList.add("settings__difficulty"),l.appendChild(i),l.appendChild(c("difficulty","Easy",e,this.handleDifficultyLevelChange.bind(this))),l.appendChild(c("difficulty","Medium",t,this.handleDifficultyLevelChange.bind(this))),l.appendChild(c("difficulty","Hard",n,this.handleDifficultyLevelChange.bind(this))),l.appendChild(m()),s.appendChild(l),s}handleMineCountChange(e){C=e.target.value,C>u.maxMineCount?(C=u.maxMineCount,this.elements.customMineCount.value=C):C<1&&(C=1,this.elements.customMineCount.value=C),document.querySelector(".settings__mine-count .warning-restart").classList.remove("hidden")}generateMineCountSelection(){const e=document.createDocumentFragment(),t=document.createElement("div");t.textContent="Mine count:";const n=document.createElement("div");return n.classList.add("settings__mine-count"),n.appendChild(t),n.appendChild(function(e,t,n){const s=document.createDocumentFragment(),i=document.createElement("input");i.type="number",i.name="mine-count",i.min=1,i.max=999,i.value=t,i.addEventListener("change",n);const l=document.createElement("div");return l.classList.add("input-number"),l.appendChild(i),s.appendChild(l),s}(0,C,this.handleMineCountChange.bind(this))),n.appendChild(m()),e.appendChild(n),e}showSettings(){const{score:e,settings:t}=this.elements;e.classList.add("hidden"),t.classList.remove("hidden")}hideSettings(){const{settings:e}=this.elements;e.classList.add("hidden")}showScore(){const{score:e}=this.elements;for(;e.firstChild;)e.removeChild(e.firstChild);const t=document.createElement("div");t.classList.add("score__title"),t.textContent="Total score";const n=document.createElement("div");n.classList.add("score__table");const s=document.createElement("div");s.textContent="№",n.appendChild(s);const i=document.createElement("div");i.textContent="Date",n.appendChild(i);const l=document.createElement("div");l.textContent="Time",n.appendChild(l);const a=document.createElement("div");a.textContent="Clicks",n.appendChild(a),(d()||[]).forEach(((e,t)=>{const s=document.createElement("div");s.textContent=t+1,n.appendChild(s);const i=document.createElement("div");var l;i.textContent=(l=e.date,new Date(l).toLocaleString()),n.appendChild(i);const a=document.createElement("div");a.textContent=e.timer,n.appendChild(a);const d=document.createElement("div");d.textContent=e.moveCount,n.appendChild(d)})),e.appendChild(t),e.appendChild(n),this.elements.settings.classList.add("hidden"),e.classList.remove("hidden")}hideScore(){const{score:e}=this.elements;e.classList.add("hidden")}getCellClasses(e,t){const n=[],s=this.cells[e][t];return s.opened?n.push("opened"):s.flagged?n.push("closed","flag"):n.push("closed"),n}getCellValue(e,t){const n=this.cells[e][t];return n.opened?n.neighborMineCount:""}getCurrentCell(e){const t=Number(e.getAttribute("i")),n=Number(e.getAttribute("j"));return this.cells[t][n]}getCurrentElement(e){return this.elements.cells.querySelector(`#cell-${e.i}-${e.j}`)}handleLeftClick(e){if(this.win||this.lose)return;this.moveCount+=1,this.elements.moveCount.textContent=o(this.moveCount);const t=e.currentTarget,n=this.getCurrentCell(t);if(!n.opened){if(n.flagged)return t.classList.remove("flag"),void(n.flagged=!1);this.gameOn||this.startNewGame(n),this.openCell(n),this.isAllCellsOpened()&&this.victory(),this.win||this.lose||r||this.audioClick.play(),this.gameOn&&l(this)}}handleRightClick(e){if(e.preventDefault(),this.win||this.lose)return;const t=e.currentTarget,n=this.getCurrentCell(t);n.opened||(t.classList.toggle("flag"),n.flagged=!n.flagged,n.flagged?(this.minesRemaining-=1,this.gameOn&&0===this.minesRemaining&&this.isMinesFlagged()&&this.victory()):this.minesRemaining+=1,this.elements.minesRemaining.textContent=o(this.minesRemaining),this.win||this.lose||r||this.audioClick.play(),this.gameOn&&l(this))}isMinesFlagged(){return this.mines.every((e=>e.flagged))}isAllCellsOpened(){for(let e=0;e<this.sizeX;e+=1)for(let t=0;t<this.sizeY;t+=1)if(!this.cells[e][t].mined&&!this.cells[e][t].opened)return!1;return!0}victory(){this.gameOn=!1,this.win=!0,this.stopTimer(),function(e,t){const n=d()||[];n.unshift({date:Date.now(),timer:e,moveCount:t})>10&&n.pop(),localStorage.setItem("totalScore",JSON.stringify(n))}(this.timer,this.moveCount),a(),r||this.audioWin.play(),this.elements.message.classList.add("message_win"),this.elements.message.textContent=`Hooray! You found all mines in ${this.timer}\n      seconds and ${this.moveCount} moves!`,this.elements.score.classList.contains("hidden")||this.showScore()}gameOver(){this.gameOn=!1,this.lose=!0,this.stopTimer(),this.openMines(),this.checkMistakes(),a(),r||this.audioLose.play(),this.elements.message.classList.add("message_lose"),this.elements.message.textContent="Game over! Try again"}openMines(){this.mines.filter((e=>!e.flagged&&!e.opened)).forEach((e=>{const t=this.getCurrentElement(e);t.classList.remove("closed"),t.classList.add("opened","mine")}))}checkMistakes(){for(let e=0;e<this.sizeX;e+=1)for(let t=0;t<this.sizeY;t+=1){const n=this.cells[e][t];if(n.flagged&&!n.mined){const n=this.elements.cells.querySelector(`#cell-${e}-${t}`);n.classList.remove("closed","flag"),n.classList.add("opened","mistake")}}}openCell(e){if(e.opened||e.flagged)return;const t=this.getCurrentElement(e);t.classList.remove("closed"),t.classList.add("opened"),this.cells[e.i][e.j].opened=!0,e.mined?(t.classList.add("mine","bang"),this.gameOver()):e.neighborMineCount>0?(t.innerText=e.neighborMineCount,t.setAttribute("value",e.neighborMineCount)):0===e.neighborMineCount&&this.openAllNeighbors(e)}openAllNeighbors(e){for(let t=e.i-1;t<=e.i+1;t+=1)for(let n=e.j-1;n<=e.j+1;n+=1)t>=0&&n>=0&&this.cells[t]&&this.cells[t][n]&&this.openCell(this.cells[t][n])}assignMines(e){this.mines=[];let t=0;for(;t<this.mineCount;){const n=i(0,this.sizeX-1),s=i(0,this.sizeY-1);this.cells[n][s].mined||e.i===n&&e.j===s||(this.cells[n][s].mined=!0,this.mines.push(this.cells[n][s]),t+=1)}}calculateNeighborMineCounts(){function e(e,t){let n=0;for(let s=e.i-1;s<=e.i+1;s+=1)for(let i=e.j-1;i<=e.j+1;i+=1)s>=0&&i>=0&&t[s]&&t[s][i]&&(n=t[s][i].mined?n+=1:n);return n}for(let t=0;t<this.sizeX;t+=1)for(let n=0;n<this.sizeY;n+=1)this.cells[t][n].mined||(this.cells[t][n].neighborMineCount=e({i:t,j:n},this.cells))}startTimer(){this.timerId=setInterval((()=>{this.timer+=1,this.elements.timer.textContent=o(this.timer),this.gameOn&&l(this)}),1e3)}stopTimer(){clearInterval(this.timerId)}createNewGame(){this.win=!1,this.lose=!1,this.timer=0,this.moveCount=0,this.sizeX=u.sizeX,this.sizeY=u.sizeY,this.difficultyLevel=u,this.mineCount=C,this.minesRemaining=C,this.generateEmptyMinefield(),this.resetHtml(),document.querySelectorAll(".warning-restart:not(.hidden)").forEach((e=>{e.classList.add("hidden")}))}stopGame(){this.gameOn=!1,this.stopTimer(),a()}continueGame(){this.startTimer(),this.gameOn=!0}startNewGame(e){this.assignMines(e),this.calculateNeighborMineCounts(),this.startTimer(),this.difficultyLevel=u,this.gameOn=!0}};window.addEventListener("DOMContentLoaded",(()=>{v.init(t)}))})();